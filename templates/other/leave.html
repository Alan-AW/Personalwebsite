{% extends 'AboutLeaveBase.html' %}
{% load static %}

{% block title %}
    <link rel="stylesheet" href="{% static 'other/leave.css' %}">
    <link rel="stylesheet" href="{% static 'comment/emoji.css' %}">
    <script type="text/javascript"
            src="http://api.map.baidu.com/api?v=2.0&ak=eGoFmU42VgXFh2OjzSjcPgd5PunNWu6p"></script>
    <script src="{% static 'blog/js/addMessage.js' %}"></script>
{% endblock %}

<!-- å¯¼è‚® -->
{% block nav %}
    <div class="navigation">
        <ul class="nav-bar">
            <li><a href="{% url 'blog:home' %}" class="animsition-link">é¦–é¡µ</a></li>
            <li><a href="{% url 'blog:about' %}" class="animsition-link">å…³äºæˆ‘</a></li>
            <li><a href="javascript:my_love()" title="è¯·è¾“å…¥å¯†ç è®¿é—®">ä¸€ä¸ªæ™®é€šç”·å­©çš„åå¹´</a></li>
        </ul>
    </div>
{% endblock %}

{% block main %}
    <div class="leave-content animsition">
        {% csrf_token %}
        <!-- ç™¾åº¦åœ°å›¾APIå®¹å™¨ -->
        <div id="allmap"></div>
        <input type="hidden" id="baidumap">
        <!-- æç¤º -->
        <div id="message_info" class="growl" style="display:none;">
            <div id="message_content" class="growl-item alert message_error"></div>
        </div>
        <div class="leave-title">
            <h2><span style="color: #09ebfc;">ç¯ç«æ˜Ÿæ˜Ÿ</span>ï¼Œ<span style="color: #ff6651;">äººå£°æ³æ³</span>ï¼Œ<span
                    style="color: #ffb351">æ­Œä¸å°½ä¹±ä¸–çƒ½ç«</span>ã€‚</h2>
            <h2><span style="color: #5197ff">ç¬”å¢¨ç‚¹ç‚¹</span>ï¼Œ<span style="color: #a551ff">ä¿¡çº¸ç³ç…</span>ï¼Œ<span
                    style="color: #ff5163">ä¹¦ä¸å®Œäººç”Ÿç™¾æ€</span>ã€‚</h2>
            <h2>æœ‰ä»€ä¹ˆæƒ³é—®çš„</h2>
            <h2>æœ‰ä»€ä¹ˆæƒ³è¯´çš„</h2>
            <h2>éƒ½å¯ä»¥å‘Šè¯‰æˆ‘å“¦ï¼Œæˆ‘éƒ½ä¼šåœ¨ç¬¬ä¸€æ—¶é—´å›å¤å“’ğŸ˜š</h2>
            <p>å› ä¸ºæˆ‘çŸ¥é“<span style="color: #09ebfc">æœ‰äº›äºº</span>ã€<span style="color: #ff6651">æœ‰äº›è¯</span>ä¸€æ—¦é”™è¿‡äº†ï¼Œå°±<span
                    style="color: #4dc14c">æ°¸è¿œ</span>é”™è¿‡äº†ğŸ˜’
            </p>
        </div>
        <div class="userMsg">
            {% if request.user.is_authenticated %}
                <input type="text" id="nickname" class="LeaveUserName" value="{{ user.username }}"
                       onkeyup="this.value=this.value.replace(/[, ]/g,'')"
                       maxlength="20">
            {% else %}
                <input type="text" id="nickname" placeholder="æ¥å°†å¯ç•™å§“å?" class="LeaveUserName"
                       onkeyup="this.value=this.value.replace(/[, ]/g,'')"
                       maxlength="20">
            {% endif %}
            <input type="text" id="emailAttr" placeholder="å›è°ƒé‚®ç®±?" class="LeaveUserName userEmail"
                   onkeyup="this.value=this.value.replace(/[, ]/g,'')"
                   maxlength="30">
            <input type="text" id="site" placeholder="ç½‘å€?" class="LeaveUserName"
                   onkeyup="this.value=this.value.replace(/[, ]/g,'')"
                   maxlength="30">
        </div>

        <div class="input_leavemsg">
            <div id="reply_content_container" style="display:none;margin-top: 20px">
                <p style="margin: 10px 0;color: #09ebfc;font-size: 18px">Ta è¯´ï¼š</p>
                <p id="reply_user" style="color: #666;font-size: 20px"></p>
                <input type="text" id="reply_pk" hidden value="">
                <p style="margin-top: 10px"><a href="javascript:cancelReply()" class="cancelReply">å–æ¶ˆ</a></p>
            </div>

            <textarea class="emotion" id="content" rows="3"
                      maxlength="500"
                      onkeyup="this.value=this.value.replace(/[, ]/g,'')"
                      placeholder="è¿˜æ˜¯è¯´ç‚¹ä»€ä¹ˆå§ï¼Œo(ï¿£ãƒ˜ï¿£oï¼ƒ)å“¼..."></textarea>
            <span id="face" class="face-icon"><strong>â˜º</strong></span>
            <a href="javascript:submitLeaveMsg()" id="default_comment_button" class="sub_leave_msg">ç•™&nbsp;è¨€</a>
        </div>
        {% if leaveCount %}
            <div class="leaveCount" style="margin: 20px 0;">å·²æ•è·&nbsp;<span id="leaveCount"
                                                                           style="color: #ff6651;">{{ leaveCount }}</span>&nbsp;åªå°å¯çˆ±çš„ç•™è¨€
            </div>
        {% else %}
            <p id="nothaveleave" style="margin: 10px 0">æ¥éƒ½æ¥äº†!ç¡®å®šä¸æŠ¢ä¸ªæ²™å‘ï¼Ÿ</p>
        {% endif %}
        <div class="leave_area">
            {% for leave in allLeave %}
                <div class="allLeaveShow">
                    <div class="leavemsg" id="root_{{ leave.pk }}">
                        <p><span class="leave-name">{{ leave.name }}</span>:<span
                                class="browserId">{{ leave.browserId }}</span>
                        </p>
                        <p class="leave-content" id="leave_{{ leave.pk }}">{{ leave.content|safe }}</p>
                        <span class="leave-time">{{ leave.createTime }}</span><span class="city">{{ leave.city }}</span><a
                            href="javascript:clickReplay({{ leave.pk }})" class="replayLeave">å›å¤Ta</a>
                        <div class="allSonLeave">
                            {% for replay in leave.rootleave.all %}
                                <div class="sonleavemsg" style="margin-left: 3em">
                                    <p><span class="zzId">{{ replay.name }}</span>å›å¤:<span
                                            class="leave-name">{{ replay.replayTo.name }}</span><span
                                            class="browserId">{{ replay.browserId }}</span></p>
                                    <p class="leave-content" id="leave_{{ replay.pk }}">{{ replay.content|safe }}</p>
                                    <span class="leave-time">{{ replay.createTime }}</span><span
                                        class="city">{{ replay.city }}</span><a
                                        href="javascript:clickReplay({{ replay.pk }})" class="replayLeave">å›å¤Ta</a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                </div>
            {% endfor %}
        </div>
    </div>
    <div class="tyc-login">
        {% csrf_token %}
        <p style="color: #777;">Tell Me Your Name</p>
        <p><input type="text" id="tyc-name" placeholder="is that you?" maxlength="5"></p>
        <a href="javascript:submit_eternal()" class="submit-tyc">click</a>
    </div>
    <div class="mask"></div>
{% endblock %}

{% block script %}
    <script src="{% static 'blog/js/animsition.js' %}"></script>
    <script src="{% static 'other/leave.js' %}"></script>
    <script src="{% static 'other/about.js' %}"></script>
    <script src="{% static 'comment/textareaEmoji.js' %}"></script>
    <script>
        // æäº¤æ ¹ç•™è¨€
        function submitLeaveMsg() {
            var content = $('#content').val();
            var nickname = $('#nickname').val();
            if (!content) {
                addMessage('fail', 'å“‡å“¦ï¼Œå°‘ä¾ ä½ æ€»å¾—è¯´ç‚¹ä»€ä¹ˆå§!');
                return false;
            } else if (!nickname) {
                addMessage('fail', 'æœ‹å‹!è´µå§“å•Šï¼Ÿ');
                return false;
            }
            $('#content').val('');
            var emailAttr = $('#emailAttr').val();
            var site = $('#site').val();
            var subContent = AnalyticEmotion(content + '[]');
            var showContent = subContent.substring(0, subContent.length - 2);
            var city = $('#baidumap').val();
            var browserId = userBrowser + userBrowserVer;
            var myDate = new Date();
            var Year = myDate.getFullYear();  // è·å–å®Œæ•´çš„å¹´ä»½(4ä½,1970-????)
            var Month = myDate.getMonth() + 1;  // è·å–å½“å‰æœˆä»½(0-11,0ä»£è¡¨1æœˆ)
            var Today = myDate.getDate();  // è·å–ä»Šå¤©çš„æ—¥æœŸ
            var today = Year + 'å¹´' + Month + 'æœˆ' + Today + 'æ—¥';  // æ‹¼æ¥å‡ºå®Œæ•´çš„æ—¥æœŸ
            var token = $("[name='csrfmiddlewaretoken']").val();
            $.ajax({
                url: '',
                type: 'post',
                data: {
                    'nickname': nickname,
                    'emailAttr': emailAttr,
                    'site': site,
                    'content': subContent,
                    'city': city,
                    'browserId': browserId,
                    'csrfmiddlewaretoken': token
                },
                success: function (data) {
                    var status = JSON.parse(data);
                    if (status.success) {
                        addMessage('success', 'nice!å·²æ”¶åˆ°æ‚¨çš„ç•™è¨€!å°å¾åŒå­¦æ­£åœ¨èµ¶æ¥ï¼ï¼')
                        var leaveNone = $('#nothaveleave');
                        var allCount = parseInt($('#leaveCount').text());
                        if (leaveNone) {
                            $('#nothaveleave').remove();
                        }
                        $('#reply_content_container').hide();
                        $("#content").attr("placeholder", "è¿˜æ˜¯è¯´ç‚¹ä»€ä¹ˆå§ï¼o(ï¿£ãƒ˜ï¿£oï¼ƒ)å“¼...");
                        var html = `<div class="leavemsg"><p><span class="leave-name">${nickname}</span>:<span class="browserId">${browserId}</span></p><p class="leave-content">${showContent}</p><span class="leave-time">${today}</span><span class="city">${city}</span></div>`
                        $('.leave_area').append(html);
                        $('#leaveCount').text(allCount + 1);
                    } else {
                        addMessage('fail', 'å•Šå“¦~ç•™è¨€å¤±è´¥äº†ï¼Œäº²ç¨åå†æ¥å§~');
                    }
                }
            })

        }

        // æäº¤å›å¤
        function submitReply() {
            var content = $('#content').val();
            var nickname = $('#nickname').val();
            if (!content) {
                addMessage('fail', 'å“‡å“¦ï¼Œå°‘ä¾ ä½ æ€»å¾—è¯´ç‚¹ä»€ä¹ˆå§!');
                return false;
            } else if (!nickname) {
                addMessage('fail', 'æœ‹å‹!è´µå§“å•Šï¼Ÿ');
                return false;
            }
            $('#content').val('');
            var subLeave = AnalyticEmotion(content + '[]');
            var rootId = $('#reply_pk').val();
            var showLeave = subLeave.substring(0, subLeave.length - 2);
            var city = $('#baidumap').val();
            var browserId = userBrowser + userBrowserVer;
            var emailAttr = $('#emailAttr').val();
            var site = $('#site').val();
            var myDate = new Date();
            var Year = myDate.getFullYear();  // è·å–å®Œæ•´çš„å¹´ä»½(4ä½,1970-????)
            var Month = myDate.getMonth() + 1;  // è·å–å½“å‰æœˆä»½(0-11,0ä»£è¡¨1æœˆ)
            var Today = myDate.getDate();  // è·å–ä»Šå¤©çš„æ—¥æœŸ
            var today = Year + 'å¹´' + Month + 'æœˆ' + Today + 'æ—¥';  // æ‹¼æ¥å‡ºå®Œæ•´çš„æ—¥æœŸ
            var token = $("[name='csrfmiddlewaretoken']").val();
            $.ajax({
                url: '/blog/addNewLeave/',
                type: 'post',
                data: {
                    'rootId': rootId,
                    'name': nickname,
                    'city': city,
                    'browserId': browserId,
                    'email': emailAttr,
                    'site': site,
                    'content': showLeave,
                    'csrfmiddlewaretoken': token
                },
                success: function (data) {
                    var status = JSON.parse(data);
                    if (status.success) {
                        $('#default_comment_button').attr('href', 'javascript:submitLeaveMsg()');
                        $('#reply_content_container').hide();
                        $("#content").attr("placeholder", "è¿˜æ˜¯è¯´ç‚¹ä»€ä¹ˆå§ï¼o(ï¿£ãƒ˜ï¿£oï¼ƒ)å“¼...");
                        addMessage('success', 'nice~å›å¤æˆåŠŸå’¯');
                        var replyTo = status.replyToUser;
                        var rootPk = status.rootId;
                        var allCount = parseInt($('#leaveCount').text());
                        var html = `<div class="sonleavemsg" style="margin-left: 3em"><p><span class="zzId">æˆ‘&nbsp;</span>å›å¤:<span class="leave-name">${replyTo}</span><span class="browserId">${browserId}</span></p><p class="leave-content">${showLeave}</p><span class="leave-time">${today}</span><span class="city">${city}</span></div>`;
                        $('#root_' + rootPk).append(html);
                        $('#leaveCount').text(allCount + 1);
                    }
                }
            })
        }

        // ç‚¹å‡»å›å¤
        function clickReplay(replay_pk) {
            $('#reply_pk').val(replay_pk);
            var html = $("#leave_" + replay_pk).html();
            $('#reply_user').html(html);
            $('#reply_content_container').show();
            $('html').animate({scrollTop: $('#content').offset().top - 400}, 500, function () {  // å°†textareaå®šä½åˆ°top 200 ä½ç½®
                $('#content').focus();  // æ–‡æœ¬æ¡†è·å¾—ç„¦ç‚¹
                $("#content").attr("placeholder", "æˆ‘è¯´ï¼š");
            });
            $('#default_comment_button').attr('href', 'javascript:submitReply()');
        }

        // å–æ¶ˆå›å¤
        function cancelReply() {
            $("#content").attr("placeholder", "çœŸçš„ä¸è¯´ç‚¹ä»€ä¹ˆå˜›ï¼Ÿ (ï½ï¿£â–½ï¿£)ï½...");
            setTimeout(function () {
                $("#content").attr("placeholder", "è¿˜æ˜¯è¯´ç‚¹ä»€ä¹ˆå§ï¼o(ï¿£ãƒ˜ï¿£oï¼ƒ)å“¼...");
            }, 3000);
            $('#reply_content_container').css('display', 'none');
            $('#default_comment_button').attr('href', 'javascript:submitLeaveMsg()');
        }
    </script>
{% endblock %}